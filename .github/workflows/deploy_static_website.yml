name: ðŸš€ Deploy Frontend

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy_static_website.yml'

env:
  DEPLOY_ENV: ${{ github.event_name == 'workflow_dispatch' && 'preprod' || 'prod' }}
  TF_WORKSPACE: ${{ github.event_name == 'workflow_dispatch' && 'preprod' || 'default' }}
  TF_VAR_environment: ${{ github.event_name == 'workflow_dispatch' && 'preprod' || 'prod' }}
  TF_VAR_resource_group_name: ${{ github.event_name == 'workflow_dispatch' && 'draw-arena-rg-preprod' || 'draw-arena-rg' }}
  TF_VAR_storage_account_name: ${{ github.event_name == 'workflow_dispatch' && 'drawarenastaticpreprod' || 'drawarenastatic2026' }}
  TF_VAR_backend_service_plan_name: ${{ github.event_name == 'workflow_dispatch' && 'draw-arena-backend-plan-preprod' || 'draw-arena-backend-plan' }}
  TF_VAR_backend_app_name: ${{ github.event_name == 'workflow_dispatch' && 'draw-arena-backend-app-preprod' || 'draw-arena-backend-app' }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: azure
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Azure CLI
        uses: azure/cli@v2
        with:
          azcliversion: latest

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.0
          terraform_wrapper: false

      - name: Configure frontend
        working-directory: ./infra
        run: |
          terraform init
          terraform workspace select "$TF_WORKSPACE" || terraform workspace new "$TF_WORKSPACE"
          API_URL=$(terraform output -raw backend_api_url)
          echo "window.API_BASE = \"$API_URL\";" > ../frontend/config.js
          echo "âœ… Frontend configured with API: $API_URL"

      - name: Deploy frontend
        working-directory: ./infra
        run: |
          STORAGE_NAME=$(terraform output -raw storage_account_name)
          
          az storage blob upload-batch \
            --destination '$web' \
            --source ../frontend \
            --account-name "$STORAGE_NAME" \
            --auth-mode login \
            --overwrite
          
          FRONTEND_URL=$(terraform output -raw static_website_url)
          echo "âœ… Frontend deployed to: $FRONTEND_URL"
          echo "FRONTEND_URL=$FRONTEND_URL" >> $GITHUB_ENV

      - name: Summary
        run: |
          echo "### ðŸŽ‰ Frontend Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** ${{ env.FRONTEND_URL }}" >> $GITHUB_STEP_SUMMARY
