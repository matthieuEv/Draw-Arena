name: ðŸš€ Deploy static website

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: azure
    steps:
      - uses: actions/checkout@v4

      - name: Remove unused files
        run: |
          rm -f ./frontend/README.md
          rm -f ./frontend/nginx.conf

      - name: Get Deploy type
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "DEPLOY_TYPE=prod" >> $GITHUB_ENV
          else
            echo "DEPLOY_TYPE=preprod" >> $GITHUB_ENV
          fi

      - name : Build Frontend
        working-directory: ./frontend
        run: |
          chmod +x ./build.sh
          chmod +x ./jcss.sh
          ./build.sh
          echo "âœ… Frontend build completed"

      - name: Get Account Name
        run: |
          if [[ "${{ env.DEPLOY_TYPE }}" == "prod" ]]; then
            echo "ACCOUNT_NAME=drawarenastaticprod" >> $GITHUB_ENV
            echo "BACKEND_URL=https://draw-arena-backend-app.azurewebsites.net/index.php/api" >> $GITHUB_ENV
          else
            echo "ACCOUNT_NAME=drawarenastaticpreprod" >> $GITHUB_ENV
            echo "BACKEND_URL=https://draw-arena-backend-app-preprod.azurewebsites.net/index.php/api" >> $GITHUB_ENV
          fi

      - name: Configure frontend with backend URL
        run: |
          sed -i "s|BACKEND_API_URL_PLACEHOLDER|${{ env.BACKEND_URL }}|g" ./frontend/config.js
          echo "âœ… Configured frontend with backend URL: ${{ env.BACKEND_URL }}"

      - name: Upload to $web (Storage key)
        run: |
          if [[ "${{ env.DEPLOY_TYPE }}" == "prod" ]]; then
            az storage blob upload-batch \
              --account-name "${{ env.ACCOUNT_NAME }}" \
              --account-key "${{ secrets.AZURE_STORAGE_KEY_PROD }}" \
              --destination '$web' \
              --source ./frontend/dist \
              --overwrite
          else
            az storage blob upload-batch \
              --account-name "${{ env.ACCOUNT_NAME }}" \
              --account-key "${{ secrets.AZURE_STORAGE_KEY_PREPROD }}" \
              --destination '$web' \
              --source ./frontend/dist \
              --overwrite
          fi

      - name: Write summary
        run: |
          echo "## ðŸš€ Deployment info" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Website deployed to https://${{ env.ACCOUNT_NAME }}.z28.web.core.windows.net" >> $GITHUB_STEP_SUMMARY
