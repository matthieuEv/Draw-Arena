name: ðŸš€ Deploy static website

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: azure
    steps:
      - uses: actions/checkout@v4

      - name: Remove unused files
        run: |
          rm -f ./frontend/README.md
          rm -f ./frontend/nginx.conf

      - name: Get Deploy type
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "DEPLOY_TYPE=prod" >> $GITHUB_ENV
          else
            echo "DEPLOY_TYPE=preprod" >> $GITHUB_ENV
          fi

      - name: Get Account Name
        run: |
          if [[ "${{ env.DEPLOY_TYPE }}" == "prod" ]]; then
            echo "ACCOUNT_NAME=drawarenastaticprod" >> $GITHUB_ENV
          else
            echo "ACCOUNT_NAME=drawarenastaticpreprod" >> $GITHUB_ENV
          fi

      - name: Upload to $web (Storage key)
        run: |
          if [[ "${{ env.DEPLOY_TYPE }}" == "prod" ]]; then
            az storage blob upload-batch \
              --account-name "${{ env.ACCOUNT_NAME }}" \
              --account-key "${{ secrets.AZURE_STORAGE_KEY_PROD }}" \
              --destination '$web' \
              --source ./frontend \
              --overwrite
          else
            az storage blob upload-batch \
              --account-name "${{ env.ACCOUNT_NAME }}" \
              --account-key "${{ secrets.AZURE_STORAGE_KEY_PREPROD }}" \
              --destination '$web' \
              --source ./frontend \
              --overwrite
          fi

      - name: Write summary
        run: |
          echo "## ðŸš€ Deployment info" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Website deployed to https://${{ env.ACCOUNT_NAME }}.z28.web.core.windows.net" >> $GITHUB_STEP_SUMMARY
