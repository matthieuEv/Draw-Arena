name: ðŸš€ Deploy Backend

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'
    paths:
      - 'backend/**'
      - '.github/workflows/deploy_backend.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: azure
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Azure CLI
        uses: azure/cli@v2
        with:
          azcliversion: latest

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.0
          terraform_wrapper: false

      - name: Get Terraform outputs
        working-directory: ./infra
        run: |
          terraform init
          echo "RESOURCE_GROUP=$(terraform output -raw resource_group_name)" >> $GITHUB_ENV
          echo "APP_NAME=$(terraform output -raw backend_app_name)" >> $GITHUB_ENV
          echo "API_URL=$(terraform output -raw backend_api_url)" >> $GITHUB_ENV

      - name: Create backend package
        run: |
          cd backend
          zip -r ../backend.zip . -x "*.git*" -x "readme.md" -x "__pycache__/*"
          echo "âœ… Backend package created"

      - name: Deploy to Azure App Service
        run: |
          az webapp deploy \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --name "${{ env.APP_NAME }}" \
            --type zip \
            --src-path backend.zip
          
          echo "âœ… Backend deployed to Azure App Service"

      - name: Wait for deployment
        run: sleep 10

      - name: Health check
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.API_URL }}/health")
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Health check passed (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ Health check failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "### ðŸŽ‰ Backend Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Backend API URL:** ${{ env.API_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ env.RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
          echo "**App Service:** ${{ env.APP_NAME }}" >> $GITHUB_STEP_SUMMARY
